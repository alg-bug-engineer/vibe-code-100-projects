# ğŸ”§ è®¤è¯ç³»ç»Ÿä¿®å¤ - 2025å¹´11æœˆ1æ—¥

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ PostgreSQL æ¨¡å¼ä¸‹é‡åˆ° **401 æœªæˆæƒ** é”™è¯¯ï¼Œæ‰€æœ‰ API è¯·æ±‚éƒ½å¤±è´¥ï¼š

```
Failed to load resource: the server responded with a status of 401 (Unauthorized)
âŒ è·å–å†å²è®°å½•å¤±è´¥: Error: æœªæˆæƒï¼šæ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ
âŒ è·å–æ ‡ç­¾ç»Ÿè®¡å¤±è´¥: Error: æœªæˆæƒï¼šæ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ
âŒ åˆ›å»ºæ¡ç›®å¤±è´¥: Error: æœªæˆæƒï¼šæ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ
```

## æ ¹æœ¬åŸå› 

### 1. è®¤è¯ Hook ä¸ç»Ÿä¸€

å¤šä¸ªç»„ä»¶ä»åœ¨ä½¿ç”¨æ—§çš„ `useLocalAuth`ï¼Œè€Œä¸æ˜¯ç»Ÿä¸€çš„ `useAuth` é€‚é…å™¨ï¼š

- âœ… **apiAdapter.ts**: å·²åˆ›å»ºç»Ÿä¸€çš„ `useAuth` Hook
- âŒ **ProtectedRoute.tsx**: ä½¿ç”¨ `useLocalAuth`
- âŒ **LocalLoginPanel.tsx**: ä½¿ç”¨ `useLocalAuth`
- âŒ **RegisterPanel.tsx**: ä½¿ç”¨ `useLocalAuth`
- âŒ **Header.tsx**: ä½¿ç”¨ `useLocalAuth`
- âŒ **ProfilePage.tsx**: ä½¿ç”¨ `useLocalAuth`
- âŒ **DevToolsPage.tsx**: ä½¿ç”¨ `useLocalAuth`

### 2. æ ‡ç­¾ç»Ÿè®¡è¿”å›æ ¼å¼ä¸ä¸€è‡´

- **PostgreSQL API** è¿”å›: `Record<string, number>` (å¯¹è±¡)
  ```typescript
  { "å·¥ä½œ": 10, "å­¦ä¹ ": 5 }
  ```
  
- **LocalStorage API** è¿”å›: `Array<{ name: string, count: number }>` (æ•°ç»„)
  ```typescript
  [{ name: "å·¥ä½œ", count: 10 }, { name: "å­¦ä¹ ", count: 5 }]
  ```

- **ReportView.tsx** æœŸæœ›: æ•°ç»„æ ¼å¼ï¼Œè°ƒç”¨ `.slice(0, 10)` å¯¼è‡´é”™è¯¯

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ç»Ÿä¸€è®¤è¯ Hook

#### æ›´æ–°çš„æ–‡ä»¶ï¼š

1. **src/db/api.ts**
   - âœ… å¯¼å‡ºç»Ÿä¸€çš„ `useAuth`
   - âœ… æ ‡è®° `useLocalAuth` ä¸ºåºŸå¼ƒ

2. **src/components/auth/ProtectedRoute.tsx**
   ```diff
   - import { useLocalAuth } from '@/db/localAuth';
   + import { useAuth } from '@/db/apiAdapter';
   
   - const { isAuthenticated } = useLocalAuth();
   + const { isAuthenticated } = useAuth();
   ```

3. **src/components/auth/LocalLoginPanel.tsx**
   ```diff
   - import { useLocalAuth } from '@/db/localAuth';
   + import { useAuth } from '@/db/apiAdapter';
   
   - const { login, loginWithPassword, isAuthenticated } = useLocalAuth();
   + const { login, loginWithPassword, isAuthenticated } = useAuth();
   ```

4. **src/components/auth/RegisterPanel.tsx**
   ```diff
   - import { useLocalAuth } from '@/db/localAuth';
   + import { useAuth } from '@/db/apiAdapter';
   
   - const { register, isAuthenticated } = useLocalAuth();
   + const { register, isAuthenticated } = useAuth();
   ```

5. **src/components/common/Header.tsx**
   ```diff
   - import { useLocalAuth } from '@/db/api';
   + import { useAuth } from '@/db/api';
   
   - const { user, isAdmin, logout } = useLocalAuth();
   + const { user, isAdmin, logout } = useAuth();
   ```

6. **src/pages/ProfilePage.tsx**
   ```diff
   - import { useLocalAuth } from '@/db/api';
   + import { useAuth } from '@/db/api';
   
   - const { user, logout } = useLocalAuth();
   + const { user, logout } = useAuth();
   ```

7. **src/pages/DevToolsPage.tsx**
   ```diff
   - import { localAuth, useLocalAuth } from '@/db/localAuth';
   + import { localAuth, useAuth } from '@/db/api';
   
   - const { user, isAuthenticated } = useLocalAuth();
   + const { user, isAuthenticated } = useAuth();
   ```

### ä¿®å¤ 2: æ ‡ç­¾ç»Ÿè®¡æ•°æ®æ ¼å¼è½¬æ¢

#### æ›´æ–°çš„æ–‡ä»¶ï¼š

**src/components/report/ReportView.tsx**
```typescript
// ä¿®å¤å‰
const [items, tags] = await Promise.all([...]);
const data: ReportData = {
  tags: tags.slice(0, 10), // âŒ tags å¯èƒ½æ˜¯å¯¹è±¡
  ...
};

// ä¿®å¤å
const [items, tags] = await Promise.all([...]);

// å°†æ ‡ç­¾ç»Ÿè®¡å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„
const tagsArray = Array.isArray(tags) 
  ? tags 
  : Object.entries(tags).map(([name, count]) => ({ name, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);

const data: ReportData = {
  tags: tagsArray, // âœ… ç¡®ä¿æ˜¯æ•°ç»„æ ¼å¼
  ...
};
```

## æµ‹è¯•éªŒè¯

### éªŒè¯æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡**
   ```bash
   # ç¡®ä¿æ•°æ®åº“è¿è¡Œ
   docker-compose up -d
   
   # å¯åŠ¨åº”ç”¨
   pnpm run dev:postgres
   ```

2. **ç™»å½•æµ‹è¯•**
   - è®¿é—® http://127.0.0.1:5173/login
   - ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•ï¼š
     - ç”¨æˆ·å: `testuser1`
     - å¯†ç : `password123`
   - âœ… åº”è¯¥æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°é¦–é¡µ

3. **API è¯·æ±‚æµ‹è¯•**
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
   - âœ… ä¸åº”è¯¥çœ‹åˆ° 401 é”™è¯¯
   - âœ… åº”è¯¥çœ‹åˆ°: "ğŸ”Œ ä½¿ç”¨ PostgreSQL æ•°æ®å­˜å‚¨"

4. **åŠŸèƒ½æµ‹è¯•**
   - âœ… åˆ›å»ºæ–°æ¡ç›®ï¼ˆQuick Inputï¼‰
   - âœ… æŸ¥çœ‹æŠ¥å‘Šé¡µé¢ï¼ˆReport Viewï¼‰
   - âœ… æŸ¥çœ‹æ ‡ç­¾ç»Ÿè®¡
   - âœ… ç”¨æˆ·ä¸ªäººèµ„æ–™é¡µé¢

### é¢„æœŸç»“æœ

- âœ… æ‰€æœ‰ API è¯·æ±‚å¸¦æœ‰æ­£ç¡®çš„ `Authorization: Bearer <token>` å¤´
- âœ… ç”¨æˆ·ç™»å½•çŠ¶æ€æ­£ç¡®ç»´æŠ¤
- âœ… è·¯ç”±å®ˆå«æ­£ç¡®å·¥ä½œ
- âœ… æ ‡ç­¾ç»Ÿè®¡æ•°æ®æ­£ç¡®æ˜¾ç¤º
- âœ… æ—  TypeScript ç¼–è¯‘é”™è¯¯
- âœ… æ— æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

## æ¶æ„æ”¹è¿›

### è®¤è¯æµç¨‹ï¼ˆä¿®å¤åï¼‰

```
ç”¨æˆ·ç™»å½•
  â†“
useAuth() Hook (ç»Ÿä¸€é€‚é…å™¨)
  â†“
æ ¹æ® VITE_STORAGE_MODE é€‰æ‹©:
  â”œâ”€ LocalStorage æ¨¡å¼: localAuth
  â””â”€ PostgreSQL æ¨¡å¼: postgresAuth
       â†“
   ä¿å­˜ JWT Token åˆ° localStorage
   cogniflow_auth_token: eyJhbGciOiJIUzI1NiIs...
       â†“
   æ‰€æœ‰ API è¯·æ±‚è‡ªåŠ¨å¸¦ä¸Š Authorization å¤´
   fetchAPI() ä» localStorage è¯»å– token
       â†“
   åç«¯éªŒè¯ JWT Token
   middleware/auth.ts
       â†“
   è¿”å›ç”¨æˆ·æ•°æ®
```

### æ•°æ®æµ

```
å‰ç«¯ç»„ä»¶
  â†“
useAuth() - ç»Ÿä¸€è®¤è¯æ¥å£
  â†“
apiAdapter.ts - æ ¹æ®æ¨¡å¼é€‰æ‹©
  â”œâ”€ LocalStorage: localAuth + userDataApi
  â””â”€ PostgreSQL: postgresAuth + postgresApi
       â†“
       HTTP è¯·æ±‚ + Bearer Token
       â†“
       Express API Server
       â†“
       auth middleware éªŒè¯ token
       â†“
       routes/items.ts + routes/users.ts
       â†“
       PostgreSQL æ•°æ®åº“
```

## å‘åå…¼å®¹æ€§

### ä¿ç•™çš„å…¼å®¹æ¥å£

1. **src/db/api.ts**
   ```typescript
   // âœ… æ–°æ¨èæ–¹å¼
   export { useAuth } from './apiAdapter';
   
   // âš ï¸ åºŸå¼ƒä½†ä¿ç•™ï¼ˆå‘åå…¼å®¹ï¼‰
   export { useLocalAuth } from './localAuth';
   ```

2. **src/db/apiAdapter.ts**
   ```typescript
   // âœ… æä¾›åˆ«å
   export { useAuth as useLocalAuth };
   ```

### è¿ç§»å»ºè®®

å¯¹äºç°æœ‰é¡¹ç›®ï¼š
1. âœ… å·²ä¿®å¤ï¼šæ ¸å¿ƒè®¤è¯ç»„ä»¶å…¨éƒ¨ä½¿ç”¨ `useAuth`
2. âš ï¸ å»ºè®®ï¼šå…¶ä»–è‡ªå®šä¹‰ç»„ä»¶é€æ­¥è¿ç§»åˆ° `useAuth`
3. ğŸ“ æ–‡æ¡£ï¼šæ ‡è®° `useLocalAuth` ä¸ºåºŸå¼ƒ

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- âœ… `src/db/apiAdapter.ts` - ç»Ÿä¸€è®¤è¯é€‚é…å™¨
- âœ… `src/db/api.ts` - API ç»Ÿä¸€å¯¼å‡º
- âœ… `src/db/postgresAuth.ts` - PostgreSQL è®¤è¯å®ç°
- âœ… `src/db/localAuth.ts` - LocalStorage è®¤è¯å®ç°

### ä¿®å¤çš„ç»„ä»¶
- âœ… `src/components/auth/ProtectedRoute.tsx`
- âœ… `src/components/auth/LocalLoginPanel.tsx`
- âœ… `src/components/auth/RegisterPanel.tsx`
- âœ… `src/components/common/Header.tsx`
- âœ… `src/components/report/ReportView.tsx`
- âœ… `src/pages/ProfilePage.tsx`
- âœ… `src/pages/DevToolsPage.tsx`

### åç«¯æ–‡ä»¶
- âœ… `server/middleware/auth.ts` - JWT éªŒè¯ä¸­é—´ä»¶
- âœ… `server/routes/items.ts` - æ¡ç›® API è·¯ç”±
- âœ… `server/routes/users.ts` - ç”¨æˆ· API è·¯ç”±

## ä¸‹ä¸€æ­¥

1. **æµ‹è¯•è¦†ç›–**
   - [ ] æ·»åŠ è®¤è¯ Hook çš„å•å…ƒæµ‹è¯•
   - [ ] æ·»åŠ  API é›†æˆæµ‹è¯•

2. **æ–‡æ¡£æ›´æ–°**
   - [x] æ›´æ–° STARTUP_GUIDE.md
   - [ ] æ›´æ–° API æ–‡æ¡£è¯´æ˜è®¤è¯æµç¨‹

3. **æ€§èƒ½ä¼˜åŒ–**
   - [ ] è€ƒè™‘ token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
   - [ ] è€ƒè™‘è®¤è¯çŠ¶æ€ç¼“å­˜ç­–ç•¥

## æ€»ç»“

### ä¿®å¤å†…å®¹
âœ… ç»Ÿä¸€äº† 7 ä¸ªç»„ä»¶çš„è®¤è¯ Hook
âœ… ä¿®å¤äº†æ ‡ç­¾ç»Ÿè®¡æ•°æ®æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
âœ… ç¡®ä¿æ‰€æœ‰ API è¯·æ±‚æ­£ç¡®æºå¸¦è®¤è¯ token
âœ… ä¿æŒå‘åå…¼å®¹æ€§

### å½±å“èŒƒå›´
- **å‰ç«¯**: 7 ä¸ªç»„ä»¶
- **åç«¯**: æ— å˜æ›´ï¼ˆå·²æ­£ç¡®å®ç°ï¼‰
- **æ•°æ®åº“**: æ— å˜æ›´

### éªŒè¯çŠ¶æ€
- âœ… ç¼–è¯‘é€šè¿‡ï¼ˆæ—  TypeScript é”™è¯¯ï¼‰
- âœ… æ¶æ„ç»Ÿä¸€ï¼ˆä½¿ç”¨ useAuth é€‚é…å™¨ï¼‰
- ğŸ”„ å¾…è¿è¡Œæ—¶éªŒè¯ï¼ˆéœ€è¦ç”¨æˆ·ç™»å½•æµ‹è¯•ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´11æœˆ1æ—¥  
**ä¿®å¤äººå‘˜**: GitHub Copilot  
**ç›¸å…³ Issue**: 401 æœªæˆæƒé”™è¯¯
