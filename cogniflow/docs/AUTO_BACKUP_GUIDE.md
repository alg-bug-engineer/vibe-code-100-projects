# 数据自动备份功能使用指南

## 功能概述

CogniFlow 现已集成完整的数据自动备份系统，可以将 IndexedDB 中的所有数据定期自动保存到本地，有效防止数据丢失。

## 主要特性

### 1. 自动备份
- ✅ 定期自动备份 IndexedDB 数据
- ✅ 可配置备份间隔（默认 30 分钟）
- ✅ 后台静默运行，不影响使用
- ✅ 支持立即手动备份

### 2. 备份存储
- ✅ 本地存储在浏览器 localStorage 中
- ✅ 可选择自动下载到文件系统
- ✅ 限制最大备份数量（默认保留 10 个）
- ✅ 自动清理过期备份

### 3. 数据恢复
- ✅ 从历史备份恢复数据
- ✅ 从本地文件导入备份
- ✅ 恢复前确认对话框
- ✅ 恢复后自动刷新页面

## 使用方法

### 访问备份管理

1. 以管理员身份登录系统
2. 点击右上角用户菜单，选择"管理面板"
3. 在管理面板中切换到"数据备份"标签

### 配置自动备份

在"备份设置"卡片中可以配置：

#### 启用自动备份
- 打开开关启用自动备份功能
- 关闭开关停止自动备份

#### 备份间隔
- 设置备份间隔（分钟）
- 建议范围：30-60 分钟
- 最小值：5 分钟
- 最大值：1440 分钟（24 小时）

#### 保留备份数量
- 设置保留的最大备份数量
- 超过此数量时自动删除最旧的备份
- 建议范围：5-10 个

#### 自动下载到文件
- 启用后每次备份会自动下载 JSON 文件到本地
- 文件命名格式：`cogniflow_backup_[ID].json`
- 可以作为额外的安全保障

### 手动备份

在"备份操作"卡片中：

1. 点击"立即备份"按钮
2. 系统会立即创建一个新备份
3. 备份完成后显示成功提示
4. 新备份会出现在"备份历史"列表中

### 查看备份历史

在"备份历史"卡片中可以看到：
- 备份创建时间
- 备份文件大小
- 备份唯一 ID

每个备份有三个操作按钮：
- 📥 **下载**：下载备份到本地文件
- 🔄 **恢复**：从此备份恢复数据
- 🗑️ **删除**：删除此备份

### 从备份恢复数据

#### 方式一：从历史备份恢复
1. 在备份历史列表中找到要恢复的备份
2. 点击"恢复"按钮（🔄）
3. 在确认对话框中点击"确认恢复"
4. 等待数据恢复完成（3秒后自动刷新页面）

#### 方式二：从文件恢复
1. 点击"从文件恢复"按钮
2. 选择之前下载的 `.json` 备份文件
3. 等待数据恢复完成（3秒后自动刷新页面）

⚠️ **注意**：恢复数据会覆盖当前所有数据，建议恢复前先创建一个新备份！

## 技术实现

### 文件结构

```
src/
├── services/
│   └── autoBackup.ts          # 自动备份服务核心逻辑
├── components/
│   └── backup/
│       └── BackupManager.tsx  # 备份管理界面组件
├── db/
│   └── indexeddb.ts          # IndexedDB 封装（含导入导出）
└── App.tsx                    # 应用入口（启动备份服务）
```

### 备份数据格式

备份文件是一个包含所有数据表的 JSON 对象：

```json
{
  "profiles": [...],  // 用户配置
  "items": [...],     // 所有条目
  "tags": [...]       // 标签统计
}
```

### 存储机制

- **元数据**：存储在 `cogniflow_backups` key
- **备份数据**：存储在 `backup_[ID]` key
- **配置**：存储在 `cogniflow_backup_config` key
- **最后备份时间**：存储在 `cogniflow_last_backup` key

### 自动清理

当 localStorage 空间不足时：
1. 自动删除最旧的备份
2. 只保留最新的一个备份
3. 释放存储空间后重试

## 最佳实践

### 推荐配置

对于日常使用，推荐以下配置：

```
启用自动备份：✅ 是
备份间隔：30 分钟
保留备份数量：10 个
自动下载到文件：❌ 否（按需开启）
```

### 定期备份策略

1. **自动备份**：保持开启，作为第一道防线
2. **手动备份**：重要操作前手动备份一次
3. **文件备份**：每周下载一次文件备份到云盘
4. **清理策略**：定期检查并删除不需要的旧备份

### 恢复建议

- 尝试先从最新的备份恢复
- 如果最新备份有问题，尝试前一个备份
- 保留文件备份作为最后的保险
- 恢复前一定要先创建当前数据的备份

## 故障排除

### 备份失败

**可能原因**：
- localStorage 空间不足
- IndexedDB 数据读取失败
- 浏览器隐私模式限制

**解决方法**：
1. 检查浏览器存储空间
2. 清理旧备份释放空间
3. 使用"自动下载到文件"功能

### 恢复失败

**可能原因**：
- 备份文件损坏
- 数据格式不兼容
- 权限不足

**解决方法**：
1. 尝试其他备份
2. 检查备份文件格式
3. 确保有足够的存储空间

### 找不到备份

**可能原因**：
- localStorage 被清空
- 浏览器缓存被清理
- 更换了浏览器或设备

**解决方法**：
1. 检查是否有下载的文件备份
2. 使用"从文件恢复"功能
3. 下次记得开启"自动下载到文件"

## 注意事项

1. ⚠️ 备份数据存储在浏览器本地，清除浏览器数据会丢失备份
2. ⚠️ 更换浏览器或设备无法访问之前的备份
3. ⚠️ 建议定期下载文件备份到云盘作为异地备份
4. ⚠️ 恢复数据会覆盖当前所有数据，请谨慎操作
5. ✅ 自动备份在应用启动时自动开始，无需手动开启
6. ✅ 备份过程不会影响正常使用

## 更新日志

### v1.0.0 (2025-01-29)
- ✨ 新增自动备份服务
- ✨ 新增备份管理界面
- ✨ 支持手动备份和恢复
- ✨ 支持从文件导入导出
- ✨ 支持备份配置管理
- ✨ 集成到管理面板

## 未来计划

- [ ] 支持加密备份
- [ ] 支持云端备份（可选）
- [ ] 支持增量备份
- [ ] 支持备份压缩
- [ ] 备份数据完整性校验
- [ ] 备份恢复预览
- [ ] 导出为 CSV/Excel 格式

## 技术支持

如有问题或建议，请联系开发团队。
